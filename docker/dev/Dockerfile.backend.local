# Dockerfile for Backend Development (Local)
FROM node:22.13.1
WORKDIR /app

# 1. Copiar SOLO package.json (ignorando lockfile local)
COPY backend/package.json ./

# 2. Instalar dependencias y hacer backup
RUN npm install && \
    mkdir -p /tmp/node_modules_backup && \
    cp -r node_modules/* /tmp/node_modules_backup/

# 3. Exponer puerto
EXPOSE 3000

# 4. Copiar script de inicio (se sobrescribirá con el volumen, pero necesario para el build)
# Convertir finales de línea CRLF a LF para evitar errores de sintaxis
COPY backend/start-dev.sh /tmp/start-dev.sh
RUN sed -i 's/\r$//' /tmp/start-dev.sh && \
    mv /tmp/start-dev.sh /app/start-dev.sh && \
    chmod +x /app/start-dev.sh

# 5. Script de arranque inteligente
# Convierte finales de línea CRLF a LF y ejecuta el script
# Esto es necesario porque el script se monta como volumen y puede tener CRLF en Windows
CMD ["sh", "-c", "sed -i 's/\\r$//' /app/start-dev.sh && sh /app/start-dev.sh"]